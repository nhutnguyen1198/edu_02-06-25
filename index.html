<!DOCTYPE html>
<html>

<head>
    <title>B·∫£n ƒë·ªì + Th·ªùi ti·∫øt c√≥ icon</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #map {
            height: 70vh;
        }

        .weather-icon {
            width: 100px;
            height: 100px;
        }
    </style>
</head>

<body>
    <div class="row g-0">
        <div class="col-md-8">
            <div id="map"></div>
        </div>
        <div class="col-md-4 p-4">
            <h2>Th√¥ng tin v·ªã tr√≠</h2>
            <p id="location-info">ƒêang l·∫•y v·ªã tr√≠...</p>
            <h4 class="mt-4">Th·ªùi ti·∫øt hi·ªán t·∫°i</h4>
            <div id="weather-info">
                <p>ƒêang t·∫£i d·ªØ li·ªáu th·ªùi ti·∫øt...</p>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const locationInfo = document.getElementById("location-info");
        const weatherInfo = document.getElementById("weather-info");

        const weatherDescriptions = {
            0: "Tr·ªùi quang",
            1: "Ch·ªß y·∫øu tr·ªùi quang",
            2: "C√≥ m√¢y nh·∫π",
            3: "Nhi·ªÅu m√¢y",
            45: "S∆∞∆°ng m√π",
            48: "S∆∞∆°ng m√π ƒë√¥ng ƒë·∫∑c",
            51: "M∆∞a ph√πn nh·∫π",
            53: "M∆∞a ph√πn v·ª´a",
            55: "M∆∞a ph√πn n·∫∑ng",
            61: "M∆∞a nh·∫π",
            63: "M∆∞a v·ª´a",
            65: "M∆∞a to",
            80: "M∆∞a r√†o nh·∫π",
            81: "M∆∞a r√†o v·ª´a",
            82: "M∆∞a r√†o to",
            95: "D√¥ng",
            96: "D√¥ng c√≥ m∆∞a nh·ªè",
            99: "D√¥ng c√≥ m∆∞a to"
        };

        function getWeatherIcon(code) {
            // B·∫°n c√≥ th·ªÉ thay c√°c icon kh√°c n·∫øu th√≠ch (ƒë√¢y l√† t·ª´ OpenWeatherMap ch·ªâ ƒë·ªÉ minh h·ªça)
            const iconMap = {
                0: "01d",
                1: "02d",
                2: "03d",
                3: "04d",
                45: "50d",
                48: "50d",
                51: "09d",
                53: "09d",
                55: "09d",
                61: "10d",
                63: "10d",
                65: "10d",
                80: "09d",
                81: "09d",
                82: "09d",
                95: "11d",
                96: "11d",
                99: "11d"
            };
            const iconCode = iconMap[code] || "01d";
            return `https://openweathermap.org/img/wn/${iconCode}@2x.png`;
        }

        function success(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            locationInfo.innerHTML = `Vƒ© ƒë·ªô: ${lat.toFixed(5)}<br>Kinh ƒë·ªô: ${lng.toFixed(5)}<br>ƒê·ªô ch√≠nh x√°c: ${Math.round(accuracy)} m√©t`;

            const map = L.map("map").setView([lat, lng], 15);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution: '&copy; OpenStreetMap contributors',
            }).addTo(map);

            const marker = L.marker([lat, lng]).addTo(map);

            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,rain,weather_code`)
                .then(response => response.json())
                .then(data => {
                    const temp = data.current.temperature_2m;
                    const code = data.current.weather_code;
                    const rain = data.current.rain;
                    const iconUrl = getWeatherIcon(code);
                    const desc = weatherDescriptions[code] || "Kh√¥ng r√µ";

                    const popupContent = `
                        B·∫°n ƒëang ·ªü ƒë√¢y!<br>
                        üå° ${temp}¬∞C - ${desc}<br>
                        ${rain > 0 ? "üåß C√≥ m∆∞a" : "üå§ Kh√¥ng m∆∞a"}
                    `;
                    marker.bindPopup(popupContent).openPopup();

                    // Hi·ªÉn th·ªã b√™n panel ph·∫£i
                    weatherInfo.innerHTML = `
                        <img src="${iconUrl}" alt="icon th·ªùi ti·∫øt" class="weather-icon"><br>
                        Nhi·ªát ƒë·ªô: <strong>${temp}¬∞C</strong><br>
                        ${desc}<br>
                        ${rain > 0 ? "C√≥ m∆∞a" : "Kh√¥ng m∆∞a"}
                    `;
                })
                .catch(err => {
                    weatherInfo.innerHTML = "<p class='text-danger'>Kh√¥ng l·∫•y ƒë∆∞·ª£c th·ªùi ti·∫øt.</p>";
                    console.error("L·ªói l·∫•y th·ªùi ti·∫øt:", err);
                });

            fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`)
                .then(res => res.json())
                .then(data => {
                    const address = data.display_name;
                    locationInfo.innerHTML += `<br>${address}`;
                })
                .catch(err => {
                    console.error("L·ªói reverse geocoding:", err);
                    locationInfo.innerHTML += `<br>Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c t·ªânh/th√†nh.`;
                });
        }

        function error(err) {
            locationInfo.textContent = "‚ùå Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠.";
            weatherInfo.innerHTML = "<p class='text-danger'>Kh√¥ng th·ªÉ l·∫•y th·ªùi ti·∫øt v√¨ l·ªói ƒë·ªãnh v·ªã.</p>";
            console.warn("L·ªói v·ªã tr√≠:", err.message);
        }

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(success, error, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        } else {
            alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.");
        }
    </script>
</body>

</html>